# 護理人員排班系統 開發日誌

## 一、原始專案開發規劃（MVP）

### 1. 產品目標
- 建立一套簡易、可擴充的護理人員排班系統，協助醫療單位有效管理護理人力與班表。

### 2. 主要功能
- **人員管理**：新增、編輯、刪除、查詢護理人員（含病房分組、批次上傳/下載）
- **班別設定**：新增、編輯、刪除、查詢班別（含病房、上班時間、所需人數、批次上傳/下載）
- **自動排班**：一鍵產生排班表（根據規則與人員資料，MVP 先用隨機分配，後續支援進階規則）
- **班表查詢**：依條件查詢班表、支援搜尋、匯出
- **班表分析**：樞紐分析表格，讓使用者自由分析班表內容
- **資料儲存**：SQLite 資料庫

### 3. 技術選型
- 前端：Flask + Bootstrap + PivotTable.js
- 後端：Python
- 資料庫：SQLite
- 匯出：CSV

---

## 二、目前已完成的功能

- 人員管理（CRUD、病房分組、批次上傳/下載）
- 班別設定（CRUD、病房欄位、批次上傳/下載）
- 自動排班（支援進階規則：每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註）
- 班表查詢（多條件搜尋、查詢結果匯出CSV）
- 班表分析（PivotTable.js 樞紐分析，支援拖曳分析）
- 所有資料皆儲存於 SQLite，資料結構可擴充

---

## 三、下一階段建議執行步驟

### 1. **自動排班進階優化**
   - 支援「月」排班（目前為週）
   - 增加更多排班規則（如排休、夜班限制、特殊人員需求）
   - 排班結果可手動微調

### 2. **權限與帳號管理**
   - 區分主管與一般護理人員權限（主管可編輯，護理人員僅查詢）
   - 登入/登出功能

### 3. **使用者體驗優化**
   - 介面美化、操作流程優化
   - 增加操作提示、錯誤訊息

### 4. **資料備份/還原**
   - 支援資料備份與還原功能

### 5. **進階報表與匯出**
   - 支援匯出 Excel
   - 匯出排班統計報表（如每人班數、每班人力分布）

### 6. **API/雲端化（選擇性）**
   - 提供 API 介面，方便未來串接其他系統
   - 部署到雲端，支援多用戶協作

---

## 四、你可以選擇的下一步

- 進行「月排班」與進階規則設計
- 權限管理與登入功能
- 介面美化與使用者體驗優化
- 進階報表與匯出
- 其他你有興趣或需求的功能

## 2025-06-xx
- 新增「月曆檢視」功能，採用 FullCalendar.js 呈現班表，支援月份切換與班別資訊提示。
- 月曆檢視頁面新增「月份選擇器」，可快速切換不同月份班表。
- 自動排班後，系統自動導向該月份的月曆檢視。
- 班表查詢頁面下方新增「本月班數統計」與警示（低於22班或高於30班以紅色顯示）。
- 介面與操作體驗優化建議：UI美化、操作提示、響應式設計。
- 補充未來建議：權限管理、手動微調、資料備份/還原、API串接、雲端化。

## 2025-06-xx 專案藍圖與行動計畫更新

### 一、現有基礎（已完成）
- 人員/班別管理（批次上傳/下載、分組、CRUD）
- 自動排班（含月排班、進階規則）
- 班表查詢/分析（多條件、CSV、月曆、PivotTable）
- 直覺化 UI（Bootstrap）

### 二、重點強化與新功能規劃
1. 法規校驗與違規預警
   - 內建《勞基法》與醫院內規自動校驗（如11小時間隔、週工時、花花班、夜班上限、加班偵測）
   - 違規即時警示、禁止輸出或自動重排
2. 偏好與例外情境處理
   - 員工偏好登記（班別、時段、固定班、特定日排除）
   - 特殊政策（如夜班間隔、培訓日排除等）
3. 手動微調與月曆互動
   - FullCalendar 拖曳修改班別
   - 異動即時儲存、異動紀錄保存（稽核用）
4. 權限分級與操作分流
   - 員工：查詢/下載個人班表
   - 主管：排班、審核、批次上傳
   - 管理員：全院統計、規則設定、資料備份
5. 報表與視覺化分析
   - 加班、夜班分布、合規分析、出勤效率等多元報表
   - 視覺化（Chart.js/ECharts）
6. 資料備份與復原
   - 每日自動備份（JSON/SQL）
   - 一鍵還原、版本切換、跨院匯出
7. API 與雲端支援
   - RESTful API（串接HR/出勤/薪資等）
   - 標準登入驗證（OAuth2/JWT）
   - 雲端部署（Heroku/AWS/Azure）

### 三、下一階段行動建議（優先順序）
| 階段            | 工作項目                      |
| ------------- | ------------------------- |
| 1️⃣ 權限管理與登入功能 | 實作登入、角色權限分級、UI 分流         |
| 2️⃣ 排班規則彈性化   | 夜班上限、輪班間隔、自訂規則介面          |
| 3️⃣ 月曆互動微調    | FullCalendar 拖曳修改、即時儲存    |
| 4️⃣ UI/UX 美化  | 響應式設計、錯誤提示與操作導引優化         |
| 5️⃣ 備份還原模組    | JSON 或 SQL 匯出/匯入按鈕與每日備份計畫 |
| 6️⃣ 報表擴充與 API | 建立統計報表介面與初步 API 架構草圖      |

---

## 2025-05-xx
- MVP功能完成：人員管理、班別設定、班表查詢、班表分析、自動排班（含進階規則）、CSV匯入匯出。
- 支援依病房分組排班、進階排班規則（每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註）。
- 首頁、班表查詢、班表分析（PivotTable.js）等主要頁面完成。

## 2025/xx/xx
- 完成班表分析頁面美化：
  - 加入活力綠主題卡片、明顯標題、說明文字。
  - 新增「匯出CSV」按鈕，可將分析結果匯出。
  - PivotTable.js 介面現代化，支援自由拖曳分析。

## 下一步建議
- 進階自動排班（夜班限制、特殊需求、手動微調）
- 權限與帳號管理（主管/一般人員、登入登出）
- 介面美化、操作提示、資料備份/還原、進階報表與匯出、API/雲端化 

## 2025-06-xx 介面美化與功能優化
- 全站主色調改為淺粉紅，首頁及所有子頁面背景、標題、卡片、按鈕皆統一色系。
- 員工橫式排班表優化：
  - 日期下方新增顯示星期（一二三四五六日）。
  - 早班、小夜班、大夜班以不同底色顯示。
- 各頁按鈕與導覽動線優化：
  - 「員工橫式排班表」按鈕移至班表查詢頁「月曆檢視」右側。
  - 各頁「回首頁」「回上一頁」按鈕位置調整，動線更直覺。
- staff頁面「批次上傳」「範本下載」按鈕版面與shift頁一致，並支援點擊自動上傳。
- staff頁面新增「篩選搜尋」功能，可依員工編號、姓名、職稱、病房即時過濾。
- 其他UI一致性優化與細節調整。 

## 2025-06-xx 下一步開發計畫

### 1️⃣ 權限管理與登入功能
- 目標：區分主管與一般護理人員權限，保障資料安全。
- 內容：
  - 實作登入/登出功能。
  - 依角色分流介面（主管可編輯，護理人員僅查詢）。
  - 介面右上角顯示登入狀態。

### 2️⃣ 排班規則彈性化
- 目標：讓排班更貼合實務需求與法規。
- 內容：
  - 夜班上限、輪班間隔、自訂規則介面。
  - 支援員工偏好、特殊排班需求（如特定日排除、固定班等）。

### 3️⃣ 月曆互動微調
- 目標：提升班表調整的便利性。
- 內容：
  - FullCalendar 拖曳修改班別。
  - 異動即時儲存、異動紀錄保存（稽核用）。

### 4️⃣ UI/UX 美化與操作提示
- 響應式設計，手機/平板友善。
- 增加操作提示、錯誤訊息、流程引導。

### 5️⃣ 資料備份與還原
- 支援資料備份（JSON/SQL）、一鍵還原、版本切換。

### 6️⃣ 進階報表與匯出
- 支援匯出 Excel、加班/夜班分布/合規分析等報表。

### 7️⃣ API/雲端化（選擇性）
- RESTful API、雲端部署。

---

## 權限管理開發計畫（2025-06-xx）

### 1. 需求規劃
- 角色區分：
  - 主管（Admin/Manager）：可新增、編輯、刪除人員與班別、執行自動排班、查詢與匯出所有班表。
  - 一般護理人員（Staff）：僅能查詢自己的班表與基本資訊，不可編輯資料。
- 登入/登出機制：
  - 使用帳號密碼登入。
  - 登入後顯示使用者名稱與角色。
  - 支援登出。
- 權限分流：
  - 依角色顯示不同功能選單與頁面。
  - 未授權操作自動導向登入或顯示權限不足提示。

### 2. 技術實作建議
- 帳號資料表設計（user）：user_id, username, password_hash, role（admin/staff）, 相關人員ID（如 staff_id）
- 密碼加密：使用 werkzeug.security hash 工具。
- Session 管理：Flask 內建 session 或 Flask-Login。
- 頁面保護：用 decorator 檢查登入與角色權限。

### 3. 頁面與流程
- 登入頁：/login
- 登出功能：/logout
- 註冊頁（可選）：僅限管理員新增帳號
- 首頁/功能頁：依登入狀態與角色顯示不同選單
- 權限不足提示頁：/unauthorized

### 4. 實作步驟建議
1. 新增 user 資料表，並建立一組管理員帳號。
2. 實作登入/登出功能，登入後將 user_id、role 存入 session。
3. 各頁加上權限檢查（如需 admin 權限才可進入）。
4. 首頁與功能頁依角色顯示不同選單。
5. 測試：未登入、不同角色登入時的功能限制。

### 5. 延伸功能（可選）
- 密碼重設
- 帳號啟用/停用
- 操作紀錄（Log） 

## 2025-06-xx 權限管理與使用者管理功能開發進度
- 全站登入保護，未登入自動導向登入頁。
- 依登入者角色（管理員/護理人員）顯示不同功能選單。
- 首頁右上角顯示登入者名稱與登出按鈕。
- 管理員專用「使用者管理」頁面：
  - 可新增、編輯、刪除使用者，設定角色與對應護理人員。
  - 支援批次上傳/下載使用者資料（CSV）。
- 月曆檢視頁面新增「員工姓名、病房、班別」篩選查詢功能。
- 介面與操作流程持續優化。 

## 2025-06-xx 重大功能與介面優化
- 新增 schedule_log（班表異動紀錄）資料表，所有班表編輯/刪除自動寫入異動紀錄。
- 班表查詢、月曆檢視頁新增「編輯」按鈕，管理員可直接編輯/刪除班表。
- 編輯班表彈窗（modal）優化：
  - 員工編號欄位支援 select2，可搜尋員工編號或姓名。
  - 權限控管，僅管理員可操作。
  - 狀態欄位改為下拉選單（正常、請假、調班、加班、缺勤、其他）。
- schedule_log 頁面可查詢所有異動紀錄，顯示異動前後內容。
- 修正 select2 在 modal 內無法搜尋的問題，改為每次 modal 彈出時初始化。
- 全站介面一致性優化，移除除錯欄位，保留乾淨操作體驗。
- README 同步更新，並已 commit/push 至 GitHub。 